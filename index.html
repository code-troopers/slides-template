<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<meta content="Asciidoctor 1.5.2" name="generator">
<meta content="Code-Troopers" name="author">
<meta content="@codetroopers @DockerTours" name="keywords">
<title>Du dev à la prod en passant par Jenkins</title>
<link href="deck.js/core/deck.core.css" rel="stylesheet">
<link href="deck.js/extensions/scale/deck.scale.css" media="screen" rel="stylesheet">
<link href="deck.js/extensions/goto/deck.goto.css" media="screen" rel="stylesheet">
<link href="deck.js/extensions/menu/deck.menu.css" media="screen" rel="stylesheet">
<link href="deck.js/extensions/status/deck.status.css" media="screen" rel="stylesheet">
<link href="deck.js/themes/style/web-2.0.css" media="screen" rel="stylesheet">
<link href="deck.js/themes/transition/fade.css" media="screen" rel="stylesheet">
<link href="ct/ct.css" rel="stylesheet">
<link href="deck.js/core/print.css" media="print" rel="stylesheet">
<script src="deck.js/modernizr.custom.js"></script>
</head>
<body class="article">
<div class="deck-container">
<section class="slide" id="title-slide">
<h1>Du dev à la prod en passant par Jenkins</h1>
<span id="author">Code-Troopers</span>
<br>
<span id="email"><a href="mailto:contact@code-troopers.com">contact@code-troopers.com</a></span>
<br>
</section>
<section class="slide" id="_qui_sommes_nous">
<h2>Qui sommes-nous ?</h2>
<div class="ulist">
<ul>
<li><p>
Benjamin Cousin<div class="ulist">
<ul>
<li>@bbbenja</li>
</ul>
</div></p></li>
<li><p>
Cedric Gatay<div class="ulist">
<ul>
<li>@Cedric_Gatay</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="paragraph"><p>Membres de Code-Troopers</p></div>
</section>
<section class="slide" id="_code_troopers">
<h2>Code-Troopers</h2>
<div class="ulist">
<ul>
<li>Docker</li>
<li>Mongo</li>
<li>Angular</li>
<li>Java</li>
<li>Android</li>
</ul>
</div>
</section>
<section class="slide" id="_code_troopers_2">
<h2>Code-Troopers</h2>
<div class="ulist">
<ul>
<li>Navig&#8217;Tours</li>
<li>Blog</li>
<li>Github</li>
<li>BBL</li>
</ul>
</div>
</section>
<section class="slide canvas-image" id="_retour_d_expérience" style="background-image: url(assets/cockpit.jpg)">

</section>
<section class="slide" id="_besoins">
<h2>Besoins</h2>
<div class="paragraph"><p>Application Java (base JHipster)</p></div>
<div class="ulist">
<ul>
<li>Java 8</li>
<li>Mongo</li>
<li>Elasticsearch</li>
<li>Git + Gitlab</li>
<li>Jenkins</li>
</ul>
</div>
</section>
<section class="slide" id="_workflow">
<h2>Workflow</h2>
<div class="ulist">
<ul>
<li>Code</li>
<li>Push</li>
<li>Merge</li>
<li>Build</li>
<li>Deploy</li>
<li>&#8230;&#8203;</li>
</ul>
</div>
</section>
<section class="slide" id="_old_school">
<h2>Old school</h2>
<div class="paragraph"><p><strong>Code</strong></p></div>
<div class="paragraph"><p>Premier développeur</p></div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">git checkout -b feature/XXX
... work ...
git commit -a -m "End my feature"
git push</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Merge</strong></p></div>
<div class="paragraph"><p>Autre développeur</p></div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">git merge feature/XXX
git tag feature/XXX
git push</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Build</strong></p></div>
<div class="paragraph"><p>Click jenkins build</p></div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">mvn package</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Deploy</strong></p></div>
<div class="paragraph"><p>Click jenkins deploy</p></div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">scp myapp.war myserver:/home/app1
ssh myserver /home/app1/deploy.sh</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Inconvénients</strong></p></div>
<div class="ulist">
<ul>
<li>Un serveur à configurer</li>
<li>Environnement de dev pas forcément aligné</li>
<li>C/C pour la preprod</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Objectif de migration</strong></p></div>
<div class="ulist">
<ul>
<li>Apprendre Docker</li>
<li>Figer les versions des services</li>
<li>Mettre en place une démarche DevOps</li>
</ul>
</div>
</section>
<section class="slide canvas-image" id="_nouveau_procédé" style="background-image: url(assets/new_formula.jpg)">

</section>
<section class="slide" id="_avec_docker">
<h2>Avec Docker</h2>
<div class="paragraph"><p><strong>Code</strong></p></div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">git checkout -b feature/XXX
... work ...
git commit -a -m "End my feature"
git push</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Merge</strong></p></div>
<div class="ulist">
<ul>
<li>Merge Request GitLab</li>
<li>Diff et commentaires</li>
<li>Hooks</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Build</strong></p></div>
<div class="ulist">
<ul>
<li>Tests automatique via Hook (même des branches)</li>
<li>Build automatique de <code>master</code></li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="screen-mr" src="assets/screen-mr.png"></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Deploy</strong></p></div>
<div class="ulist">
<ul>
<li>Automatique pour prp</li>
<li>Manuel pour prod (click-click)</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="screen-jenkins" src="assets/screen-jenkins.png"></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Bénéfices</strong></p></div>
<div class="ulist">
<ul>
<li>Moins d&#8217;opérations manuelles en CLI</li>
<li>Moins d&#8217;erreur d&#8217;étapes sautées</li>
<li>Validation de la qualité même sur les branches</li>
</ul>
</div>
</section>
<section class="slide canvas-image" id="_et_docker_dans_tout_ça" style="background-image: url(assets/docker_cargo.jpg)">

</section>
<section class="slide" id="_côté_deploy">
<h2>Côté Deploy</h2>
<div class="ulist">
<ul>
<li>docker-compose décrit la stack</li>
<li>utilisation d&#8217;images publiques et privées</li>
<li><p>
Makefile descriptif des différentes actions:<div class="ulist">
<ul>
<li>deploy prod</li>
<li>deploy preprod</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="_côté_build">
<h2>Côté Build</h2>
<div class="ulist">
<ul>
<li><p>
Build de l&#8217;application<div class="ulist">
<ul>
<li>Utilisation de slave Jenkins</li>
<li>Archivage du livrable</li>
</ul>
</div></p></li>
<li><p>
Build de l&#8217;image Docker<div class="ulist">
<ul>
<li>Copie du livrable de l&#8217;app</li>
<li>Dockerfile de l&#8217;application</li>
<li>Push vers un registry privé</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="_côté_dev">
<h2>Côté Dev</h2>
<div class="ulist">
<ul>
<li><p>
Pas d&#8217;installations locale<div class="ulist">
<ul>
<li>Mongo via Docker</li>
<li>ElasticSearch via Docker</li>
</ul>
</div></p></li>
<li>Java / Maven / Grunt par contre en local</li>
</ul>
</div>
</section>
<section class="slide canvas-image" id="_retour_sur_la_solution" style="background-image: url(assets/iceberg.jpg)">

</section>
<section class="slide" id="_pro">
<h2>Pro</h2>
<div class="paragraph"><p><strong>Deploy</strong></p></div>
<div class="paragraph"><p>On créée autant d&#8217;instance qu&#8217;on veut</p></div>
<div class="ulist">
<ul>
<li>plusieurs niveau de préprod possibles</li>
<li>on peut tester une montée de version facilement</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Build</strong></p></div>
<div class="paragraph"><p>Machine Jenkins non polluée</p></div>
<div class="ulist">
<ul>
<li>uniquement Docker présent</li>
<li>permet de lancer des tests d&#8217;intégration facilement</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Dev</strong></p></div>
<div class="paragraph"><p>Environnement de prod facilement reproductible</p></div>
<div class="paragraph"><p>Machine de dev non polluée</p></div>
<div class="paragraph"><p>Coût d&#8217;entrée minime pour le nouvel arrivant</p></div>
</section>
<section class="slide" id="_cons">
<h2>Cons</h2>
<div class="paragraph"><p><strong>Deploy</strong></p></div>
<div class="ulist">
<ul>
<li>Problème de ports publics exposés</li>
<li>Gestion des logs</li>
<li>Problème de redémarrage du serveur</li>
<li>Espace disque utilisé important</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Build</strong></p></div>
<div class="ulist">
<ul>
<li>Installation d&#8217;un registry privé pénible</li>
<li>Problème de durée de build</li>
<li>Le build se lance en léger différé</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Dev</strong></p></div>
<div class="paragraph"><p>Performances faibles lors du montage de volumes sous Windows/OS X</p></div>
</section>
<section class="slide canvas-image" id="_tips" style="background-image: url(assets/tips.jpeg)">

</section>
<section class="slide" id="_tips_2">
<h2>Tips</h2>
<div class="paragraph"><p><strong>Deploy</strong></p></div>
<div class="ulist">
<ul>
<li><code>jwilder/nginx-proxy</code> : gestion des virtual hosts</li>
<li>driver de logs : <code>journald</code> pour le logrotate</li>
<li><code>--restart=always</code> : penser à spécifier la politique de restart</li>
<li><code>docker-cleanup-volumes</code> : suppression des volumes orphelins</li>
<li><code>FROM debian</code> est plus léger que <code>FROM ubuntu</code></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Build</strong></p></div>
<div class="ulist">
<ul>
<li>Monter un volume pour le cache Maven/Gradle</li>
<li><a href="http://cedric.gatay.fr/slides-template/docker-jenkins-slave/">Docker Jenkins Slave @ ToursJUG</a></li>
<li>docker-registry <a class="bare" href="https://code-troopers.com/2015/06/25/InstallDockerRegistry.html">https://code-troopers.com/2015/06/25/InstallDockerRegistry.html</a></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Dev</strong></p></div>
<div class="paragraph"><p>Ne pas utiliser les montages VirtualBox:</p></div>
<div class="ulist">
<ul>
<li>rsync</li>
<li>samba</li>
<li>data-volumes</li>
</ul>
</div>
<div class="paragraph"><p>Sous OSX :</p></div>
<div class="ulist">
<ul>
<li><code>docker-osx-dev</code> : préconfigure boot2docker avec rsync</li>
</ul>
</div>
</section>
<section class="slide" id="_monitoring">
<h2>Monitoring</h2>
<div class="ulist">
<ul>
<li>New Relic : remontée utilisation CPU/IO/Docker</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">docker run -d \
	--privileged=true --name newrelic
	--pid=host \
	--net=host \
	-v /sys:/sys \
	-v /dev:/dev \
	--restart=always \
	-v /var/run/docker.sock:/var/run/docker.sock \
	-v /var/log:/var/log:rw \
	-e NRSYSMOND_license_key=&lt;KEY&gt; \
	-e NRSYSMOND_logfile=/var/log/nrsysmond.log \
	newrelic/nrsysmond:latest</code></pre>
</div>
</div>
</section>
<section class="slide" id="_docker">
<h2>Docker</h2>
<div class="paragraph"><p><strong>Installation Serveur</strong></p></div>
<div class="ulist">
<ul>
<li>installation du daemon</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">curl -sSL https://get.docker.com/ | sh</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>ouverture de l&#8217;API Docker à l&#8217;extérieur</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">DOCKER_OPTS="-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock"</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Installation Client</strong></p></div>
<div class="ulist">
<ul>
<li>La version du client doit être alignée avec celle du serveur</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">VERSION=1.6.2 curl -o docker https://get.docker.com/builds/Linux/x86_64/docker-$VERSION &amp;&amp; chmod +x docker
export DOCKER_HOST=MY_MACHINE:2375
./docker ps</code></pre>
</div>
</div>
</section>
<section class="slide canvas-image" id="_avantages_ct" style="background-image: url(assets/trooper_dance.jpg)">

</section>
<section class="slide" id="_montée_en_compétences">
<h2>Montée en compétences</h2>
<div class="ulist">
<ul>
<li><p>
Migration vers Docker de plusieurs applications<div class="ulist">
<ul>
<li>Service de synchronisation (Java/Mongo)</li>
<li>Service d&#8217;identification (Java7)</li>
<li>Navig&#8217;Tours (Heroku &gt; Docker)</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="_axes_d_améliorations">
<h2>Axes d&#8217;améliorations</h2>
<div class="ulist">
<ul>
<li>Déploiement zéro downtime</li>
<li>Jenkins Docker workflow plugin</li>
<li>Docker Swarm</li>
</ul>
</div>
</section>
<section class="slide canvas-image" id="_questions" style="background-image: url(assets/questions.jpg)">

</section>
<p aria-role="status" class="deck-status">
<span class="deck-status-current"></span>
/
<span class="deck-status-total"></span>
</p>
<form action="." class="goto-form" method="get">
<label for="goto-slide">Go to Slide:</label>
<input id="goto-slide" list="goto-datalist" name="slidenum" type="text">
<datalist id="goto-data-list"></datalist>
<input type="submit" value="Go">
</form>
</div>
<script src="deck.js/jquery.min.js"></script>
<script src="deck.js/core/deck.core.js"></script>
<script src="deck.js/extensions/scale/deck.scale.js"></script>
<script src="deck.js/extensions/goto/deck.goto.js"></script>
<script src="deck.js/extensions/menu/deck.menu.js"></script>
<script src="deck.split.js"></script>
<script src="deck.js/extensions/status/deck.status.js"></script>
<script src="ct/ct.js"></script>
<script>
  (function($, deck, undefined) {
    $.deck.defaults.keys['previous'] = [8, 33, 37, 39];
    $.deck.defaults.keys['next'] = [13, 32, 34, 39];
  
    $.extend(true, $[deck].defaults, {
        countNested: false
    });
  
    $.deck('.slide');
  })(jQuery, 'deck');
</script>
<style>
  .slide.canvas-image {
  -moz-background-size: cover;
  -webkit-background-size: cover;
  -o-background-size: cover;
  background-size: cover;
  display: -moz-box;
  display: -webkit-box;
  display: -ms-box;
  display: box;
  -moz-box-orient: vertical;
  -webkit-box-orient: vertical;
  -ms-box-orient: vertical;
  box-orient: vertical;
  -moz-box-align: start;
  -webkit-box-align: start;
  -ms-box-align: start;
  box-align: start;
  -moz-box-pack: start;
  -webkit-box-pack: start;
  -ms-box-pack: start;
  box-pack: start;}
  
  .bottom-left {
    left: 1%;
    bottom: 20%; }
  
  .top-left {
    left: 1%;
    top: 20%; }
  
  .bottom-right {
    right: 1%;
    bottom: 20%; }
  
  .top-right {
    right: 1%;
    top: 20%; }
  
  .center-up {
    right: 50%;
    top: 1%;
  }
  
  .center-down {
    right: 50%;
    bottom: 1%;
  }
  .canvas-image .canvas-caption p {
    text-align: center;
    padding-top: 0;
    padding: 0;
    -moz-transform: none;
    -webkit-transform: none;
    -o-transform: none;
    -ms-transform: none;
    transform: none;
    display: inline;
    position: absolute;
    background-color: rgba(0, 0, 0, 0.7);
    font-weight: bold;
    font-size: 58px;
    -webkit-box-shadow: 2px 2px 2px #000;
    -moz-box-shadow: 2px 2px 2px #000;
    box-shadow: 2px 2px 2px #000;
    padding: 1rem;
    color: white; }
  kbd.keyseq { color: #555555; }
  kbd:not(.keyseq) {
    display: inline-block;
    color: #222222;
    font-size: 0.7em;
    line-height: 1.4;
    background-color: #F7F7F7;
    border: 1px solid #ccc;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset;
    margin: -0.15em 0.15em 0 0.15em;
    padding: 0.2em 0.6em;
    vertical-align: middle;
    white-space: nowrap;
  }
  kbd kbd:first-child { margin-left: 0; }
  kbd kbd:last-child { margin-right: 0; }
</style>
</body>
</html>